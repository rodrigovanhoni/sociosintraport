<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Sistema de Carteirinhas</title>
        <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @media screen and (orientation: landscape) {
                .card-container {
                    transform: rotate(0deg);
                }
            }

            .fullscreen-card {
                width: 100vw;
                height: 100vh;
                background: white;
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 1000;
            }

            .fullscreen-card.active {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .watermark {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-30deg);
                font-size: 4rem;
                color: rgba(0, 0, 0, 0.1);
                white-space: nowrap;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const App = () => {
                const [currentScreen, setCurrentScreen] =
                    React.useState("search"); // 'search' ou 'card'
                const [memberData, setMemberData] = React.useState(null);
                const [isLoading, setIsLoading] = React.useState(false);
                const [error, setError] = React.useState(null);

                const searchMember = async (cpf) => {
                    try {
                        setIsLoading(true);
                        setError(null);

                        const response = await fetch(`/api/member/${cpf}`);

                        if (response.status === 403) {
                            const data = await response.json();
                            if (data.status === 'pendente') {
                                 throw new Error("Este dependente está aguardando aprovação");
                            } else if (data.status === 'reprovado') {
                                 throw new Error("Cadastro de dependente não aprovado");
                            }
                            
                        }
                        
                        if (!response.ok) {
                            throw new Error("Membro não encontrado");
                        }

                        

                        const data = await response.json();
                        setMemberData(data);
                        setCurrentScreen("card");
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setIsLoading(false);
                    }
                };

                return (
                    <div className="min-h-screen bg-gray-100 py-6 flex flex-col justify-center sm:py-12">
                        {currentScreen === "search" ? (
                            <SearchScreen
                                onSearch={searchMember}
                                isLoading={isLoading}
                                error={error}
                            />
                        ) : (
                            <MembershipCard
                                {...memberData}
                                onBack={() => setCurrentScreen("search")}
                            />
                        )}
                    </div>
                );
            };

            const CaptchaImage = ({ text }) => {
                const canvasRef = React.useRef(null);

                React.useEffect(() => {
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    
                    // Limpar canvas
                    ctx.fillStyle = '#f3f4f6';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Adicionar ruído/linhas
                    for (let i = 0; i < 10; i++) {
                        ctx.beginPath();
                        ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
                        ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
                        ctx.strokeStyle = '#' + Math.floor(Math.random()*16777215).toString(16);
                        ctx.stroke();
                    }

                    // Desenhar texto com distorção
                    ctx.font = 'bold 24px Arial';
                    ctx.fillStyle = '#000';
                    const chars = text.split('');
                    let x = 10;
                    chars.forEach(char => {
                        const rotation = (Math.random() - 0.5) * 0.5;
                        ctx.save();
                        ctx.translate(x, 30);
                        ctx.rotate(rotation);
                        ctx.fillText(char, 0, 0);
                        ctx.restore();
                        x += 20;
                    });
                }, [text]);

                return <canvas ref={canvasRef} width="200" height="60" />;
            };

           
            const SearchScreen = ({ onSearch, isLoading, error }) => {
                const [cpf, setCpf] = React.useState("");
                const [captcha, setCaptcha] = React.useState({ question: "", answer: 0 });
                const [userAnswer, setUserAnswer] = React.useState("");
                const [captchaError, setCaptchaError] = React.useState("");
                const [showCaptcha, setShowCaptcha] = React.useState(true);

                const generateCaptcha = () => {
                    const num1 = Math.floor(Math.random() * 10);
                    const num2 = Math.floor(Math.random() * 10);
                    setCaptcha({
                        question: `${num1} + ${num2}`,
                        answer: num1 + num2
                    });
                    setUserAnswer("");
                };

                React.useEffect(() => {
                    generateCaptcha();
                }, []);

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    
                    if (parseInt(userAnswer) !== captcha.answer) {
                        setCaptchaError("Resposta incorreta. Tente novamente.");
                        generateCaptcha();
                        return;
                    }

                    setShowCaptcha(false);
                    await onSearch(cpf);
                    generateCaptcha();
                    setShowCaptcha(true);
                };

                const formatCPF = (value) => {
                    return value
                        .replace(/\D/g, "")
                        .replace(/(\d{3})(\d)/, "$1.$2")
                        .replace(/(\d{3})(\d)/, "$1.$2")
                        .replace(/(\d{3})(\d{1,2})/, "$1-$2")
                        .replace(/(-\d{2})\d+?$/, "$1");
                };

                const handleCPFChange = (e) => {
                    setCpf(formatCPF(e.target.value));
                };

                return (
                    <div className="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
                        <h2 className="text-2xl font-bold text-center text-blue-600 mb-6">
                            Emissão de Carteirinha
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label htmlFor="cpf" className="block text-sm font-medium text-gray-700">
                                    Digite seu CPF
                                </label>
                                <input
                                    type="text"
                                    id="cpf"
                                    value={cpf}
                                    onChange={handleCPFChange}
                                    placeholder="000.000.000-00"
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    maxLength="14"
                                    required
                                />
                            </div>

                            {showCaptcha && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Resolva a operação abaixo:
                                    </label>
                                    <div className="mb-2">
                                        <CaptchaImage text={captcha.question} />
                                    </div>
                                    <input
                                        type="number"
                                        value={userAnswer}
                                        onChange={(e) => {
                                            setUserAnswer(e.target.value);
                                            setCaptchaError("");
                                        }}
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        placeholder="Digite o resultado"
                                        required
                                    />
                                    <button
                                        type="button"
                                        onClick={generateCaptcha}
                                        className="mt-2 text-sm text-blue-600 hover:text-blue-800"
                                    >
                                        Gerar nova pergunta
                                    </button>
                                    {captchaError && (
                                        <p className="mt-1 text-sm text-red-600">{captchaError}</p>
                                    )}
                                </div>
                            )}

                            {error && (
                                <div className="text-red-600 text-sm">
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={isLoading}
                                className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300"
                            >
                                {isLoading ? "Buscando..." : "Buscar"}
                            </button>
                        </form>
                    </div>
                );
            };

            const MembershipCard = ({
                name,
                memberNumber,
                cpf,
                issueDate,
                validUntil,
                photo,
                is_socio, // novo campo
                onBack,
            }) => {
                const [isLoading, setIsLoading] = React.useState(false);
                const [isFullscreen, setIsFullscreen] = React.useState(false);
                const [showModal, setShowModal] = React.useState(false);
                const [codigo, setCodigo] = React.useState("");
                const [error, setError] = React.useState("");
                const [telefone, setTelefone] = React.useState(""); // Adicionado estado para telefone

                // Função para entrar em tela cheia
                const enterFullscreen = () => {
                    const elem = document.documentElement;
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    }
                    setIsFullscreen(true);
                    // Tenta forçar orientação paisagem
                    if (screen.orientation) {
                        screen.orientation.lock("landscape").catch(() => {
                            console.log("Rotação automática não suportada");
                        });
                    }
                };

                // Função para sair da tela cheia
                const exitFullscreen = () => {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                    setIsFullscreen(false);
                    if (screen.orientation) {
                        screen.orientation.unlock();
                    }
                };

                // Adicione esta função de compressão de imagem
                const compressImage = async (base64String) => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.src = base64String;
                        img.onload = () => {
                            const canvas = document.createElement("canvas");
                            const ctx = canvas.getContext("2d");

                            // Define o tamanho máximo
                            const maxWidth = 400;
                            const maxHeight = 600;

                            let width = img.width;
                            let height = img.height;

                            // Redimensiona mantendo a proporção
                            if (width > height) {
                                if (width > maxWidth) {
                                    height *= maxWidth / width;
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width *= maxHeight / height;
                                    height = maxHeight;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;

                            // Desenha a imagem redimensionada
                            ctx.drawImage(img, 0, 0, width, height);

                            // Converte para JPEG com qualidade reduzida
                            const compressedBase64 = canvas.toDataURL(
                                "image/jpeg",
                                0.7,
                            );
                            resolve(compressedBase64);
                        };
                    });
                };

                // Versão paisagem da carteirinha
                // Dentro do componente MembershipCard, na parte do if(isFullscreen)
                if (isFullscreen) {
                    return (
                        <div className="fixed inset-0 bg-blue-50 flex items-center justify-center">
                            <div className="relative w-full max-w-5xl h-96 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl shadow-2xl border-2 border-blue-600 m-4">
                                <div className="relative z-10 h-full flex flex-col">
                                    {/* Cabeçalho */}
                                    <div className="flex items-center p-4 border-b border-blue-200 bg-white/50">
                                        <div className="flex items-center space-x-4">
                                            <img
                                                src="./logo-sintraport.png"
                                                alt="Logo Sintraport"
                                                className="h-24 w-auto"
                                            />

                                            <div>
                                                <h1 className="text-2xl font-bold text-blue-800">
                                                    SINDICATO DOS TRABALHADORES
                                                    PORTUARIOS DO PARANA
                                                </h1>
                                                {is_socio ? (
                                                    <p className="text-lg text-blue-600">
                                                        Carteira de
                                                        Identificação do Sócio
                                                    </p>
                                                ) : (
                                                    <p className="text-lg text-blue-600">
                                                        Carteira de
                                                        Identificação de
                                                        Dependente
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    {/* Conteúdo Principal */}
                                    <div className="flex flex-1 p-6">
                                        {/* Coluna da esquerda - Foto */}
                                        <div className="w-1/3 flex flex-col items-center border-r border-blue-200">
                                            <div className="w-40 h-48 rounded-lg overflow-hidden border-2 border-blue-600 mb-4 bg-white">
                                                {photo && (
                                                    <img
                                                        src={photo}
                                                        alt="Foto do sócio"
                                                        className="w-full h-full object-cover"
                                                    />
                                                )}
                                            </div>
                                        </div>

                                        {/* Coluna da direita - Informações */}
                                        <div className="w-2/3 pl-8">
                                            <div className="grid grid-cols-2 gap-y-4 gap-x-6 mt-2">
                                                <div>
                                                    <p className="text-sm text-blue-600">
                                                        Nome
                                                    </p>
                                                    <p className="font-bold text-lg">
                                                        {name}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-blue-600">
                                                        CPF
                                                    </p>
                                                    <p className="font-bold text-lg">
                                                        {cpf}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-blue-600">
                                                        Data de Emissão
                                                    </p>
                                                    <p className="font-bold text-lg">
                                                        {issueDate}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-blue-600">
                                                        Válida até
                                                    </p>
                                                    <p className="font-bold text-lg">
                                                        {validUntil}
                                                    </p>
                                                </div>
                                                {is_socio && (
                                                    <div>
                                                        <p className="text-sm text-blue-600">
                                                            Matrícula
                                                        </p>
                                                        <p className="font-bold text-lg">
                                                            {memberNumber}
                                                        </p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    {/* Rodapé */}
                                    <div className="text-center p-2 border-t border-blue-200 bg-white/50">
                                        <p className="text-sm text-blue-600">
                                            Este documento é de uso pessoal e
                                            intransferível
                                        </p>
                                    </div>
                                </div>

                                {/* Botão de sair atualizado */}
                                <button
                                    onClick={() => {
                                        if (
                                            typeof exitFullscreen === "function"
                                        ) {
                                            exitFullscreen();
                                        }
                                        if (document.fullscreenElement) {
                                            document
                                                .exitFullscreen()
                                                .catch((err) =>
                                                    console.log(err),
                                                );
                                        }
                                    }}
                                    className="absolute top-4 right-4 bg-blue-800 text-white p-2 rounded-full hover:bg-blue-700 transition-colors z-50"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        className="h-6 w-6"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            strokeLinecap="round"
                                            strokeLinejoin="round"
                                            strokeWidth={2}
                                            d="M6 18L18 6M6 6l12 12"
                                        />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    );
                }

                //resto
                return (
                    <div className="max-w-3xl mx-auto p-4">
                        <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-600 relative overflow-hidden">
                            {/* Marca d'água */}
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <img
                                    src="./logo-sintraport.png"
                                    alt="Logo Sintraport"
                                    className="w-[500px] opacity-10 select-none transform rotate-[-30deg]"
                                />
                            </div>

                            {/* Conteúdo principal (mantido sobre a marca d'água) */}
                            <div className="relative z-10">
                                {/* Cabeçalho com título centralizado */}
                                {is_socio ? (
                                    <div className="text-center mb-6">
                                        <h1 className="text-2xl font-bold text-[#003366]">
                                            Carteira de Identificação do Sócio
                                        </h1>
                                    </div>
                                ) : (
                                    <div className="text-center mb-6">
                                        <h1 className="text-2xl font-bold text-[#003366]">
                                            Carteira de Identificação de
                                            Dependente
                                        </h1>
                                    </div>
                                )}
                                {/* Container principal em grid */}
                                <div className="grid grid-cols-[auto,1fr] gap-6">
                                    {/* Coluna da foto */}
                                    <div className="flex justify-center items-start">
                                        <div className="w-[150px] h-[200px] border-2 border-[#003366] rounded-lg overflow-hidden">
                                            {photo && (
                                                <img
                                                    src={photo}
                                                    alt="Foto do sócio"
                                                    className="w-full h-full object-cover"
                                                />
                                            )}
                                        </div>
                                    </div>

                                    {/* Coluna das informações */}
                                    <div className="flex flex-col justify-center space-y-4">
                                        <div>
                                            <p className="text-sm text-gray-600">
                                                Nome
                                            </p>
                                            <p className="font-bold text-lg">
                                                {name}
                                            </p>
                                        </div>
                                        {is_socio && (
                                            <div>
                                                <p className="text-sm text-gray-600">
                                                    Matrícula
                                                </p>
                                                <p className="font-bold">
                                                    {memberNumber}
                                                </p>
                                            </div>
                                        )}
                                        <div>
                                            <p className="text-sm text-gray-600">
                                                CPF
                                            </p>
                                            <p className="font-bold">{cpf}</p>
                                        </div>

                                        <div>
                                            <p className="text-sm text-gray-600">
                                                Data de Emissão
                                            </p>
                                            <p className="font-bold">
                                                {issueDate}
                                            </p>
                                        </div>
                                        <div>
                                            <p className="text-sm text-gray-600">
                                                Válida até
                                            </p>
                                            <p className="font-bold">
                                                {validUntil}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                {/* Rodapé */}
                                <div className="text-center mt-6 pt-4 border-t border-gray-200">
                                    <p className="text-sm text-gray-600">
                                        Este documento é de uso pessoal e
                                        intransferível
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Botões */}
                        <div className="mt-4 flex justify-center gap-4">
                            <button
                                onClick={onBack}
                                className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                            >
                                Voltar
                            </button>
                            <button
                                onClick={enterFullscreen}
                                className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
                            >
                                Ver em Tela Cheia
                            </button>
                            {is_socio && ( // Só mostra o botão se for sócio
                                <button
                                    onClick={async () => {
                                        try {
                                            setIsLoading(true);
                                            setError("");

                                            const response = await fetch(
                                                "/solicitar-codigo",
                                                {
                                                    method: "POST",
                                                    headers: {
                                                        "Content-Type":
                                                            "application/json",
                                                    },
                                                    body: JSON.stringify({
                                                        cpf,
                                                    }),
                                                },
                                            );

                                            const data = await response.json();

                                            if (data.success) {
                                                setShowModal(true);
                                                setTelefone(data.telefone); // Adicione este estado: const [telefone, setTelefone] = React.useState('');
                                            } else {
                                                setError(
                                                    data.message ||
                                                        "Erro ao enviar código",
                                                );
                                            }
                                        } catch (error) {
                                            setError(
                                                "Erro ao enviar código de verificação",
                                            );
                                        } finally {
                                            setIsLoading(false);
                                        }
                                    }}
                                    disabled={isLoading}
                                    className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-blue-300"
                                >
                                    {isLoading ? "Enviando..." : "Dependentes"}
                                </button>
                            )}
                        </div>
                        {/* Modal */}
                        {showModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-lg p-6 max-w-sm w-full">
                                    <h2 className="text-xl font-bold mb-4">
                                        Digite o código de verificação
                                    </h2>
                                    <p className="text-gray-600 mb-4">
                                        Um código foi enviado para seu celular {telefone}
                                    </p>

                                    <input
                                        type="text"
                                        value={codigo}
                                        onChange={(e) =>
                                            setCodigo(e.target.value)
                                        }
                                        placeholder="Digite o código"
                                        className="w-full px-3 py-2 border border-gray-300 rounded mb-4"
                                        maxLength={6}
                                    />

                                    {error && (
                                        <p className="text-red-500 text-sm mb-4">
                                            {error}
                                        </p>
                                    )}

                                    <div className="flex justify-end gap-2">
                                        <button
                                            onClick={() => {
                                                setShowModal(false);
                                                setCodigo("");
                                                setError("");
                                            }}
                                            className="px-4 py-2 text-gray-600 hover:text-gray-800"
                                        >
                                            Cancelar
                                        </button>

                                        <button
                                            onClick={async () => {
                                                try {
                                                    setIsLoading(true);
                                                    setError("");

                                                    console.log(
                                                        "Enviando para verificação:",
                                                        { cpf, codigo },
                                                    ); // Log dos dados enviados

                                                    const response =
                                                        await fetch(
                                                            "/verificar-codigo",
                                                            {
                                                                method: "POST",
                                                                headers: {
                                                                    "Content-Type":
                                                                        "application/json",
                                                                },
                                                                body: JSON.stringify(
                                                                    {
                                                                        cpf,
                                                                        codigo,
                                                                    },
                                                                ),
                                                            },
                                                        );

                                                    console.log(
                                                        "Status da resposta:",
                                                        response.status,
                                                    ); // Log do status HTTP

                                                    const data =
                                                        await response.json();
                                                    console.log(
                                                        "Resposta do servidor:",
                                                        data,
                                                    ); // Log da resposta completa

                                                    if (data.success) {
                                                        window.location.href = `/dependentes/${data.socioId}`;
                                                    } else {
                                                        setError(
                                                            data.message ||
                                                                "Código inválido",
                                                        );
                                                    }
                                                } catch (error) {
                                                    console.error(
                                                        "Erro detalhado:",
                                                        error,
                                                    ); // Log detalhado do erro
                                                    setError(
                                                        "Erro ao verificar código",
                                                    );
                                                } finally {
                                                    setIsLoading(false);
                                                }
                                            }}
                                            disabled={isLoading}
                                            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-blue-300"
                                        >
                                            {isLoading
                                                ? "Verificando..."
                                                : "Verificar"}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<App />);
        </script>
    </body>
</html>
