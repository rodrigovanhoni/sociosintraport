<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Sistema de Carteirinhas</title>
        <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @media screen and (orientation: landscape) {
                .card-container {
                    transform: rotate(0deg);
                }
            }

            .fullscreen-card {
                width: 100vw;
                height: 100vh;
                background: white;
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 1000;
            }

            .fullscreen-card.active {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .watermark {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-30deg);
                font-size: 4rem;
                color: rgba(0, 0, 0, 0.1);
                white-space: nowrap;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const App = () => {
                const [currentScreen, setCurrentScreen] =
                    React.useState("search"); // 'search' ou 'card'
                const [memberData, setMemberData] = React.useState(null);
                const [isLoading, setIsLoading] = React.useState(false);
                const [error, setError] = React.useState(null);

                const searchMember = async (cpf) => {
                    try {
                        setIsLoading(true);
                        setError(null);

                        const response = await fetch(`/api/member/${cpf}`);

                        if (!response.ok) {
                            throw new Error("Membro não encontrado");
                        }

                        const data = await response.json();
                        setMemberData(data);
                        setCurrentScreen("card");
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setIsLoading(false);
                    }
                };

                return (
                    <div className="min-h-screen bg-gray-100 py-6 flex flex-col justify-center sm:py-12">
                        {currentScreen === "search" ? (
                            <SearchScreen
                                onSearch={searchMember}
                                isLoading={isLoading}
                                error={error}
                            />
                        ) : (
                            <MembershipCard
                                {...memberData}
                                onBack={() => setCurrentScreen("search")}
                            />
                        )}
                    </div>
                );
            };

            const SearchScreen = ({ onSearch, isLoading, error }) => {
                const [cpf, setCpf] = React.useState("");

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSearch(cpf);
                };

                // Função para formatar o CPF enquanto digita
                const formatCPF = (value) => {
                    return value
                        .replace(/\D/g, "") // Remove tudo o que não é dígito
                        .replace(/(\d{3})(\d)/, "$1.$2") // Coloca ponto após os primeiros 3 dígitos
                        .replace(/(\d{3})(\d)/, "$1.$2") // Coloca ponto após os segundos 3 dígitos
                        .replace(/(\d{3})(\d{1,2})/, "$1-$2") // Coloca hífen antes dos últimos 2 dígitos
                        .replace(/(-\d{2})\d+?$/, "$1"); // Remove os dígitos após os 2 últimos
                };

                const handleCPFChange = (e) => {
                    setCpf(formatCPF(e.target.value));
                };

                return (
                    <div className="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
                        <h2 className="text-2xl font-bold text-center text-blue-600 mb-6">
                            Emissão de Carteirinha
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label
                                    htmlFor="cpf"
                                    className="block text-sm font-medium text-gray-700"
                                >
                                    Digite seu CPF
                                </label>
                                <input
                                    type="text"
                                    id="cpf"
                                    value={cpf}
                                    onChange={handleCPFChange}
                                    placeholder="000.000.000-00"
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    maxLength="14"
                                    required
                                />
                            </div>

                            {error && (
                                <div className="text-red-600 text-sm">
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={isLoading}
                                className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300"
                            >
                                {isLoading ? "Buscando..." : "Buscar"}
                            </button>
                        </form>
                    </div>
                );
            };

            const MembershipCard = ({
                name,
                memberNumber,
                cpf,
                issueDate,
                validUntil,
                photo,
                onBack,
            }) => {
                const [isLoading, setIsLoading] = React.useState(false);
                const [isFullscreen, setIsFullscreen] = React.useState(false);

                // Função para entrar em tela cheia
                const enterFullscreen = () => {
                    const elem = document.documentElement;
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    }
                    setIsFullscreen(true);
                    // Tenta forçar orientação paisagem
                    if (screen.orientation) {
                        screen.orientation.lock("landscape").catch(() => {
                            console.log("Rotação automática não suportada");
                        });
                    }
                };

                // Função para sair da tela cheia
                const exitFullscreen = () => {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                    setIsFullscreen(false);
                    if (screen.orientation) {
                        screen.orientation.unlock();
                    }
                };

                const generatePDF = async () => {
                    try {
                        setIsLoading(true);

                        // Comprimir a imagem antes de enviar
                        const compressedPhoto =
                            photo && (await compressImage(photo));

                        const response = await fetch("/api/generate-card", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                name,
                                memberNumber,
                                cpf,
                                issueDate,
                                validUntil,
                                photo: compressedPhoto || null,
                            }),
                        });

                        if (!response.ok) {
                            throw new Error("Erro ao gerar PDF");
                        }

                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);

                        const a = document.createElement("a");
                        a.href = url;
                        a.download = "carteirinha.pdf";
                        document.body.appendChild(a);
                        a.click();

                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } catch (error) {
                        console.error("Erro:", error);
                        alert("Erro ao gerar carteirinha");
                    } finally {
                        setIsLoading(false);
                    }
                };

                // Adicione esta função de compressão de imagem
                const compressImage = async (base64String) => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.src = base64String;
                        img.onload = () => {
                            const canvas = document.createElement("canvas");
                            const ctx = canvas.getContext("2d");

                            // Define o tamanho máximo
                            const maxWidth = 400;
                            const maxHeight = 600;

                            let width = img.width;
                            let height = img.height;

                            // Redimensiona mantendo a proporção
                            if (width > height) {
                                if (width > maxWidth) {
                                    height *= maxWidth / width;
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width *= maxHeight / height;
                                    height = maxHeight;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;

                            // Desenha a imagem redimensionada
                            ctx.drawImage(img, 0, 0, width, height);

                            // Converte para JPEG com qualidade reduzida
                            const compressedBase64 = canvas.toDataURL(
                                "image/jpeg",
                                0.7,
                            );
                            resolve(compressedBase64);
                        };
                    });
                };

                // Versão paisagem da carteirinha
                // Dentro do componente MembershipCard, na parte do if(isFullscreen)
                if (isFullscreen) {
                    return (
                        <div className="fixed inset-0 bg-blue-50 flex items-center justify-center">
                            <div className="relative w-full max-w-5xl h-96 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl shadow-2xl border-2 border-blue-600 m-4">
                                <div className="relative z-10 h-full flex flex-col">
                                    {/* Cabeçalho */}
                                    <div className="flex items-center p-4 border-b border-blue-200 bg-white/50">
                                        <div className="flex items-center space-x-4">
                                            <img
                                                src="./logo-sintraport.png"
                                                alt="Logo Sintraport"
                                                className="h-24 w-auto"
                                            />
                                            <div>
                                                <h1 className="text-2xl font-bold text-blue-800">
                                                    SINDICATO DOS TRABALHADORES
                                                    ADMINISTRATIVOS EM CAPATAZIA
                                                </h1>
                                                <p className="text-lg text-blue-600">
                                                    Carteira de Identificação do
                                                    Sócio
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Conteúdo Principal */}
                                    <div className="flex flex-1 p-6">
                                        {/* Coluna da esquerda - Foto */}
                                        <div className="w-1/3 flex flex-col items-center border-r border-blue-200">
                                            <div className="w-40 h-48 rounded-lg overflow-hidden border-2 border-blue-600 mb-4 bg-white">
                                                {photo && (
                                                    <img
                                                        src={photo}
                                                        alt="Foto do sócio"
                                                        className="w-full h-full object-cover"
                                                    />
                                                )}
                                            </div>
                                        </div>

                                        {/* Coluna da direita - Informações */}
                                        <div className="w-2/3 pl-8">
                                            <div className="grid grid-cols-2 gap-y-4 gap-x-6 mt-2">
                                                <div>
                                                    <p className="text-sm text-blue-600">
                                                        Nome
                                                    </p>
                                                    <p className="font-bold text-lg">
                                                        {name}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-blue-600">
                                                        CPF
                                                    </p>
                                                    <p className="font-bold text-lg">
                                                        {cpf}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-blue-600">
                                                        Data de Emissão
                                                    </p>
                                                    <p className="font-bold text-lg">
                                                        {issueDate}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-blue-600">
                                                        Válida até
                                                    </p>
                                                    <p className="font-bold text-lg">
                                                        {validUntil}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-blue-600">
                                                        Matrícula
                                                    </p>
                                                    <p className="font-bold text-lg">
                                                        {memberNumber}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Rodapé */}
                                    <div className="text-center p-2 border-t border-blue-200 bg-white/50">
                                        <p className="text-sm text-blue-600">
                                            Este documento é de uso pessoal e
                                            intransferível
                                        </p>
                                    </div>
                                </div>

                                {/* Botão de sair atualizado */}
                                <button
                                    onClick={() => {
                                        if (
                                            typeof exitFullscreen === "function"
                                        ) {
                                            exitFullscreen();
                                        }
                                        if (document.fullscreenElement) {
                                            document
                                                .exitFullscreen()
                                                .catch((err) =>
                                                    console.log(err),
                                                );
                                        }
                                    }}
                                    className="absolute top-4 right-4 bg-blue-800 text-white p-2 rounded-full hover:bg-blue-700 transition-colors z-50"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        className="h-6 w-6"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            strokeLinecap="round"
                                            strokeLinejoin="round"
                                            strokeWidth={2}
                                            d="M6 18L18 6M6 6l12 12"
                                        />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    );
                }

                //resto
                return (
                    <div className="max-w-3xl mx-auto p-4">
                        <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-600 relative overflow-hidden">
                            {/* Marca d'água */}
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <div className="transform rotate-[-30deg] text-gray-100 text-7xl font-bold select-none">
                                    SINTRAPORT
                                </div>
                            </div>

                            {/* Conteúdo principal (mantido sobre a marca d'água) */}
                            <div className="relative z-10">
                                {/* Cabeçalho com título centralizado */}
                                <div className="text-center mb-6">
                                    <h1 className="text-2xl font-bold text-[#003366]">
                                        Carteira de Identificação do Sócio
                                    </h1>
                                </div>

                                {/* Container principal em grid */}
                                <div className="grid grid-cols-[auto,1fr] gap-6">
                                    {/* Coluna da foto */}
                                    <div className="flex justify-center items-start">
                                        <div className="w-[150px] h-[200px] border-2 border-[#003366] rounded-lg overflow-hidden">
                                            {photo && (
                                                <img
                                                    src={photo}
                                                    alt="Foto do sócio"
                                                    className="w-full h-full object-cover"
                                                />
                                            )}
                                        </div>
                                    </div>

                                    {/* Coluna das informações */}
                                    <div className="flex flex-col justify-center space-y-4">
                                        <div>
                                            <p className="text-sm text-gray-600">
                                                Nome
                                            </p>
                                            <p className="font-bold text-lg">
                                                {name}
                                            </p>
                                        </div>

                                        <div>
                                            <p className="text-sm text-gray-600">
                                                Matrícula
                                            </p>
                                            <p className="font-bold">
                                                {memberNumber}
                                            </p>
                                        </div>

                                        <div>
                                            <p className="text-sm text-gray-600">
                                                CPF
                                            </p>
                                            <p className="font-bold">{cpf}</p>
                                        </div>

                                        <div>
                                            <p className="text-sm text-gray-600">
                                                Data de Emissão
                                            </p>
                                            <p className="font-bold">
                                                {issueDate}
                                            </p>
                                        </div>
                                        <div>
                                            <p className="text-sm text-gray-600">
                                                Válida até
                                            </p>
                                            <p className="font-bold">
                                                {validUntil}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                {/* Rodapé */}
                                <div className="text-center mt-6 pt-4 border-t border-gray-200">
                                    <p className="text-sm text-gray-600">
                                        Este documento é de uso pessoal e
                                        intransferível
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Botões */}
                        <div className="mt-4 flex justify-center gap-4">
                            <button
                                onClick={onBack}
                                className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                            >
                                Voltar
                            </button>
                            <button
                                onClick={enterFullscreen}
                                className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
                            >
                                Ver em Tela Cheia
                            </button>
                            <button
                                onClick={generatePDF}
                                disabled={isLoading}
                                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-blue-300"
                            >
                                {isLoading
                                    ? "Gerando PDF..."
                                    : "Gerar Carteirinha (PDF)"}
                            </button>
                        </div>
                    </div>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<App />);
        </script>
    </body>
</html>
